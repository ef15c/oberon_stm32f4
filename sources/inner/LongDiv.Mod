MODULE LongDiv;
  IMPORT SYSTEM;

  TYPE DivParam* = RECORD D*, S*: LONGINT END;

  PROCEDURE DivL*(VAR p: DivParam);
    (* Divides 2 64bit integers. D is dividend, S is divisor
        at exit D becomes D MOD S and S becomes D DIV S *)
    VAR clzd, clzs, coef, coef2: INTEGER; neg: BOOLEAN; q, rd: LONGINT;
  BEGIN (* Int64 division *)
    IF p.S > 0 THEN
      neg := FALSE;
      IF p.D < 0 THEN neg := TRUE; p.D := -p.D END;
      clzd := CLZ(p.D); clzs :=  CLZ(p.S);
      IF (clzd >= 32) & (clzs >= 32) THEN (*both D and S fit in INTEGER, we can use 32bit division*)
        clzd := SYSTEM.VAL(INTEGER, p.D) DIV SYSTEM.VAL(INTEGER, p.S); 
        DEC(SYSTEM.VAL(INTEGER, p.D), clzd*SYSTEM.VAL(INTEGER, p.S)); p.S := clzd
      ELSE (*64bit division is required*) coef := clzs - clzd;
        IF coef < 0 THEN p.S := 0
        ELSE q := 0; rd := p.S; IF coef > 0 THEN rd := LSL(rd, coef) END;
          WHILE p.D >= p.S DO
            IF p.D < rd THEN rd := LSR(rd, 1); q := LSL(q, 1); DEC(coef) END;
            DEC(p.D, rd); INC(q);
            clzd := CLZ(p.D); clzs := CLZ(rd); coef2 := clzd - clzs; IF coef2 > coef THEN coef2 := coef END;
            IF coef2 > 0 THEN q := LSL(q, coef2); rd := LSR(rd, coef2); DEC(coef, coef2) END
          END; p.S := q
        END
      END; IF neg THEN p.D := -p.D; p.S := -p.S END
    END
  END DivL;
END LongDiv.

OM4Tool.DecObj LongDiv.m4c
decode LongDiv.m4c
LongDiv F96D031F   1    656
imports:
type descriptors
 00000020 FFFFFFFF FFFFFFFF FFFFFFFF FFFFFFFF
data     0
strings

code
commands:
entries
 00000260 00000000 00000000
pointer refs

fixP =        0
fixD =        0
fixT =        0
entry =      608
 00000000	     B089	SUB SP SP #36
 00000002	     B403	PUSH R0 R1
 00000004	     B500	PUSH LR
 00000006	     9801	LDR R0 [ SP + 4 ]
 00000008	 E9D00102	LDRD R0 R1 [ R0 + 8 ]
 0000000C	     2801	CMP R0 #1
 0000000E	 F1710100	SBCS R1 R1 #0
 00000012	 F2C08121	BLT #578, goes to  00000258
 00000016	     2000	MOVS R0 #0
 00000018	 F88D001C	STRB R0 [  SP + 28 ]
 0000001C	     9801	LDR R0 [ SP + 4 ]
 0000001E	 E9D00100	LDRD R0 R1 [ R0 + 0 ]
 00000022	     2800	CMP R0 #0
 00000024	 F1710100	SBCS R1 R1 #0
 00000028	 F280800D	BGE #26, goes to  00000046
 0000002C	     2001	MOVS R0 #1
 0000002E	 F88D001C	STRB R0 [  SP + 28 ]
 00000032	     9801	LDR R0 [ SP + 4 ]
 00000034	 E9D00100	LDRD R0 R1 [ R0 + 0 ]
 00000038	     2200	MOVS R2 #0
 0000003A	     4240	RSBS R0 R0 #0
 0000003C	 EB720101	SBCS R1 R2 R1 LSL #0
 00000040	     9A01	LDR R2 [ SP + 4 ]
 00000042	 E9C20100	STRD R0 R1 [ R2 + 0 ]
 00000046	     9801	LDR R0 [ SP + 4 ]
 00000048	 E9D00100	LDRD R0 R1 [ R0 + 0 ]
 0000004C	 FAB1F181	CLZ R1 R1
 00000050	     2920	CMP R1 #32
 00000052	     BF06	ITTE EQ
 00000054	 FAB0F080	CLZEQ R0 R0
 00000058	     1808	ADDEQ R0 R1 R0
 0000005A	     4608	MOVNE R0 R1
 0000005C	     9003	STR R0 [ SP + 12 ]
 0000005E	     9801	LDR R0 [ SP + 4 ]
 00000060	 E9D00102	LDRD R0 R1 [ R0 + 8 ]
 00000064	 FAB1F181	CLZ R1 R1
 00000068	     2920	CMP R1 #32
 0000006A	     BF06	ITTE EQ
 0000006C	 FAB0F080	CLZEQ R0 R0
 00000070	     1808	ADDEQ R0 R1 R0
 00000072	     4608	MOVNE R0 R1
 00000074	     9004	STR R0 [ SP + 16 ]
 00000076	     9803	LDR R0 [ SP + 12 ]
 00000078	     2820	CMP R0 #32
 0000007A	 F2C0801F	BLT #62, goes to  000000BC
 0000007E	     9804	LDR R0 [ SP + 16 ]
 00000080	     2820	CMP R0 #32
 00000082	 F2C0801B	BLT #54, goes to  000000BC
 00000086	     9801	LDR R0 [ SP + 4 ]
 00000088	     6880	LDR R0 [ R0 + 8 ]
 0000008A	     2800	CMP R0 #0
 0000008C	     BFD8	IT LE
 0000008E	 EC005056	TrapLE 6 at pos 645
 00000092	     9901	LDR R1 [ SP + 4 ]
 00000094	     6809	LDR R1 [ R1 + 0 ]
 00000096	 FBB1F0F0	UDIV R0 R1 R0
 0000009A	     9003	STR R0 [ SP + 12 ]
 0000009C	     9803	LDR R0 [ SP + 12 ]
 0000009E	     9901	LDR R1 [ SP + 4 ]
 000000A0	     6889	LDR R1 [ R1 + 8 ]
 000000A2	     4348	MULS R0 R1 R0
 000000A4	     9901	LDR R1 [ SP + 4 ]
 000000A6	     680A	LDR R2 [ R1 + 0 ]
 000000A8	     1A12	SUBS R2 R2 R0
 000000AA	     600A	STR R2 [  R1 + 0 ]
 000000AC	     9803	LDR R0 [ SP + 12 ]
 000000AE	 F34071C0	SBFX R1 R0 #31 #1
 000000B2	     9A01	LDR R2 [ SP + 4 ]
 000000B4	 E9C20102	STRD R0 R1 [ R2 + 8 ]
 000000B8	 F000B8B5	B #362, goes to  00000226
 000000BC	     9804	LDR R0 [ SP + 16 ]
 000000BE	     9903	LDR R1 [ SP + 12 ]
 000000C0	     1A40	SUBS R0 R0 R1
 000000C2	     9005	STR R0 [ SP + 20 ]
 000000C4	     9805	LDR R0 [ SP + 20 ]
 000000C6	     2800	CMP R0 #0
 000000C8	 F2808007	BGE #14, goes to  000000DA
 000000CC	     2000	MOVS R0 #0
 000000CE	     2100	MOVS R1 #0
 000000D0	     9A01	LDR R2 [ SP + 4 ]
 000000D2	 E9C20102	STRD R0 R1 [ R2 + 8 ]
 000000D6	 F000B8A6	B #332, goes to  00000226
 000000DA	     2000	MOVS R0 #0
 000000DC	     2100	MOVS R1 #0
 000000DE	 E9CD0108	STRD R0 R1 [ SP + 32 ]
 000000E2	     9801	LDR R0 [ SP + 4 ]
 000000E4	 E9D00102	LDRD R0 R1 [ R0 + 8 ]
 000000E8	 E9CD010A	STRD R0 R1 [ SP + 40 ]
 000000EC	     9805	LDR R0 [ SP + 20 ]
 000000EE	     2800	CMP R0 #0
 000000F0	 F3408011	BLE #34, goes to  00000116
 000000F4	 E9DD010A	LDRD R0 R1 [ SP + 40 ]
 000000F8	     9A05	LDR R2 [ SP + 20 ]
 000000FA	 F1B20420	SUBS R4 R2 #32
 000000FE	 FA10F404	LSLS R4 R0 R4
 00000102	 F1D20320	RSBS R3 R2 #32
 00000106	     4091	LSLS R1 R1 R2
 00000108	 FA30F303	LSRS R3 R0 R3
 0000010C	     4321	ORRS R1 R1 R4
 0000010E	     4090	LSLS R0 R0 R2
 00000110	     4319	ORRS R1 R1 R3
 00000112	 E9CD010A	STRD R0 R1 [ SP + 40 ]
 00000116	     9801	LDR R0 [ SP + 4 ]
 00000118	 E9D00100	LDRD R0 R1 [ R0 + 0 ]
 0000011C	     9A01	LDR R2 [ SP + 4 ]
 0000011E	 E9D22302	LDRD R2 R3 [ R2 + 8 ]
 00000122	     4290	CMP R0 R2
 00000124	     4199	SBCS R1 R1 R3
 00000126	 F2C08079	BLT #242, goes to  0000021C
 0000012A	     9801	LDR R0 [ SP + 4 ]
 0000012C	 E9D00100	LDRD R0 R1 [ R0 + 0 ]
 00000130	 E9DD230A	LDRD R2 R3 [ SP + 40 ]
 00000134	     4290	CMP R0 R2
 00000136	     4199	SBCS R1 R1 R3
 00000138	 F2808013	BGE #38, goes to  00000162
 0000013C	 E9DD010A	LDRD R0 R1 [ SP + 40 ]
 00000140	     0840	LSRS R0 R0 #1
 00000142	 EA5070C1	ORRS R0 R0 R1 LSL #31
 00000146	     0849	LSRS R1 R1 #1
 00000148	 E9CD010A	STRD R0 R1 [ SP + 40 ]
 0000014C	 E9DD0108	LDRD R0 R1 [ SP + 32 ]
 00000150	     0049	LSLS R1 R1 #1
 00000152	 EA5171D0	ORRS R1 R1 R0 LSR #31
 00000156	     0040	LSLS R0 R0 #1
 00000158	 E9CD0108	STRD R0 R1 [ SP + 32 ]
 0000015C	     9805	LDR R0 [ SP + 20 ]
 0000015E	     1E40	SUBS R0 R0 #1
 00000160	     9005	STR R0 [ SP + 20 ]
 00000162	     9801	LDR R0 [ SP + 4 ]
 00000164	 E9D01200	LDRD R1 R2 [ R0 + 0 ]
 00000168	 E9DD340A	LDRD R3 R4 [ SP + 40 ]
 0000016C	     1AC9	SUBS R1 R1 R3
 0000016E	     41A2	SBCS R2 R2 R4
 00000170	 E9C01200	STRD R1 R2 [ R0 + 0 ]
 00000174	 E9DD0108	LDRD R0 R1 [ SP + 32 ]
 00000178	     1C40	ADDS R0 R0 #1
 0000017A	 F1510100	ADCS R1 R1 #0
 0000017E	 E9CD0108	STRD R0 R1 [ SP + 32 ]
 00000182	     9801	LDR R0 [ SP + 4 ]
 00000184	 E9D00100	LDRD R0 R1 [ R0 + 0 ]
 00000188	 FAB1F181	CLZ R1 R1
 0000018C	     2920	CMP R1 #32
 0000018E	     BF06	ITTE EQ
 00000190	 FAB0F080	CLZEQ R0 R0
 00000194	     1808	ADDEQ R0 R1 R0
 00000196	     4608	MOVNE R0 R1
 00000198	     9003	STR R0 [ SP + 12 ]
 0000019A	 E9DD010A	LDRD R0 R1 [ SP + 40 ]
 0000019E	 FAB1F181	CLZ R1 R1
 000001A2	     2920	CMP R1 #32
 000001A4	     BF06	ITTE EQ
 000001A6	 FAB0F080	CLZEQ R0 R0
 000001AA	     1808	ADDEQ R0 R1 R0
 000001AC	     4608	MOVNE R0 R1
 000001AE	     9004	STR R0 [ SP + 16 ]
 000001B0	     9803	LDR R0 [ SP + 12 ]
 000001B2	     9904	LDR R1 [ SP + 16 ]
 000001B4	     1A40	SUBS R0 R0 R1
 000001B6	     9006	STR R0 [ SP + 24 ]
 000001B8	     9806	LDR R0 [ SP + 24 ]
 000001BA	     9905	LDR R1 [ SP + 20 ]
 000001BC	     4288	CMP R0 R1
 000001BE	 F3408002	BLE #4, goes to  000001C6
 000001C2	     9805	LDR R0 [ SP + 20 ]
 000001C4	     9006	STR R0 [ SP + 24 ]
 000001C6	     9806	LDR R0 [ SP + 24 ]
 000001C8	     2800	CMP R0 #0
 000001CA	 F3408026	BLE #76, goes to  0000021A
 000001CE	 E9DD0108	LDRD R0 R1 [ SP + 32 ]
 000001D2	     9A06	LDR R2 [ SP + 24 ]
 000001D4	 F1B20420	SUBS R4 R2 #32
 000001D8	 FA10F404	LSLS R4 R0 R4
 000001DC	 F1D20320	RSBS R3 R2 #32
 000001E0	     4091	LSLS R1 R1 R2
 000001E2	 FA30F303	LSRS R3 R0 R3
 000001E6	     4321	ORRS R1 R1 R4
 000001E8	     4090	LSLS R0 R0 R2
 000001EA	     4319	ORRS R1 R1 R3
 000001EC	 E9CD0108	STRD R0 R1 [ SP + 32 ]
 000001F0	 E9DD010A	LDRD R0 R1 [ SP + 40 ]
 000001F4	     9A06	LDR R2 [ SP + 24 ]
 000001F6	 F1D20420	RSBS R4 R2 #32
 000001FA	 FA11F404	LSLS R4 R1 R4
 000001FE	 F1B20320	SUBS R3 R2 #32
 00000202	     40D0	LSRS R0 R0 R2
 00000204	 FA31F303	LSRS R3 R1 R3
 00000208	     4320	ORRS R0 R0 R4
 0000020A	     4318	ORRS R0 R0 R3
 0000020C	     40D1	LSRS R1 R1 R2
 0000020E	 E9CD010A	STRD R0 R1 [ SP + 40 ]
 00000212	     9805	LDR R0 [ SP + 20 ]
 00000214	     9906	LDR R1 [ SP + 24 ]
 00000216	     1A40	SUBS R0 R0 R1
 00000218	     9005	STR R0 [ SP + 20 ]
 0000021A	     E77C	B #-264, goes to  00000116
 0000021C	 E9DD0108	LDRD R0 R1 [ SP + 32 ]
 00000220	     9A01	LDR R2 [ SP + 4 ]
 00000222	 E9C20102	STRD R0 R1 [ R2 + 8 ]
 00000226	 F89D001C	LDRB R0 [ SP + 28 ]
 0000022A	     2800	CMP R0 #0
 0000022C	 F0008014	BEQ #40, goes to  00000258
 00000230	     9801	LDR R0 [ SP + 4 ]
 00000232	 E9D00100	LDRD R0 R1 [ R0 + 0 ]
 00000236	     2200	MOVS R2 #0
 00000238	     4240	RSBS R0 R0 #0
 0000023A	 EB720101	SBCS R1 R2 R1 LSL #0
 0000023E	     9A01	LDR R2 [ SP + 4 ]
 00000240	 E9C20100	STRD R0 R1 [ R2 + 0 ]
 00000244	     9801	LDR R0 [ SP + 4 ]
 00000246	 E9D00102	LDRD R0 R1 [ R0 + 8 ]
 0000024A	     2200	MOVS R2 #0
 0000024C	     4240	RSBS R0 R0 #0
 0000024E	 EB720101	SBCS R1 R2 R1 LSL #0
 00000252	     9A01	LDR R2 [ SP + 4 ]
 00000254	 E9C20102	STRD R0 R1 [ R2 + 8 ]
 00000258	 F85DEB04	LDR LR [ SP ] + 4
 0000025C	     B00B	ADD SP SP #44
 0000025E	     4770	BX LR
 00000260	     B500	PUSH LR
 00000262	 F85DEB04	LDR LR [ SP ] + 4
 00000266	     4770	BX LR
