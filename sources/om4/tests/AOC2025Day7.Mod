MODULE AOC2025Day7;
  IMPORT Texts, Oberon, L := SystemLog;

  CONST size = 170;

  TYPE ProcessProc = PROCEDURE(h, w: INTEGER);

  VAR W: Texts.Writer;
    nb: LONGINT;

    map: ARRAY size, size OF CHAR;

  PROCEDURE parse(process: ProcessProc);
    VAR S!: Texts.Scanner; ch: CHAR; i, j, w: INTEGER;
  BEGIN
    Texts.OpenScanner(S, Oberon.Par.text, Oberon.Par.pos);
    Texts.Read(S, ch); WHILE ch = Texts.CR DO Texts.Read(S, ch) END;
    w := 0; i := 0; j := 0;
    WHILE (ch = ".") OR (ch = "S") OR  (ch = "^") OR (ch = Texts.CR) DO
      IF ch = Texts.CR THEN INC(i); IF w = 0 THEN w := j ELSE ASSERT(w = j) END; j := 0
      ELSE map[i, j] := ch; INC(j)
      END;
      Texts.Read(S, ch)
    END;
    process(i, w)
  END parse;

  PROCEDURE doPart1(h, w: INTEGER);
    VAR i, j: INTEGER;
  BEGIN
    FOR i := 1 TO h - 1 DO
      FOR j := 0 TO w - 1 DO
        IF (map[i - 1, j] = "S") OR (map[i - 1, j] = "|") THEN
          IF map[i, j] = "^" THEN INC(nb);
            ASSERT(j > 0); map[i, j - 1] := "|";
            ASSERT(j < w - 1); map[i, j + 1] := "|"
          ELSE map[i, j] := "|"
          END
        END
      END
    END
  END doPart1;

  PROCEDURE doPart2(h, w: INTEGER);
    VAR i, j: INTEGER; tl0, tl: ARRAY size OF LONGINT;
  BEGIN
   FOR j := 0 TO w - 1 DO IF map[0, j] = "S" THEN tl0[j] := 1 ELSE tl0[j] := 0 END END;
    FOR i := 1 TO h - 1 DO
      FOR j := 0 TO w - 1 DO tl[j] := 0 END;
      FOR j := 0 TO w - 1 DO
        IF map[i, j] = "^" THEN INC(tl[j - 1], tl0[j]); INC(tl[j + 1], tl0[j])
        ELSE INC(tl[j], tl0[j])
        END
      END;
      tl0 := tl
    END;
    FOR j := 0 TO w - 1 DO INC(nb, tl[j]) END
  END doPart2;

  PROCEDURE part1*;
  BEGIN
    nb := 0; parse(doPart1);
    Texts.WriteString(W, "Partie 1: nb = "); Texts.WriteInt(W, nb, 1); Texts.WriteLn(W);
    Texts.Append(Oberon.Log, W.buf)
  END part1;

  PROCEDURE part2*;
  BEGIN
    nb := 0; parse(doPart2);
    Texts.WriteString(W, "Partie 2: nb = "); Texts.WriteInt(W, nb, 1); Texts.WriteLn(W);
    Texts.Append(Oberon.Log, W.buf)
  END part2;

BEGIN Texts.OpenWriter(W)
END AOC2025Day7.

OM4P.Compile AOC2025Day7.Mod/s~
System.Free AOC2025Day7~


test
Partie 1: nb = 21
AOC2025Day7.part1
Partie 2: nb = 40
AOC2025Day7.part2
.......S.......
...............
.......^.......
...............
......^.^......
...............
.....^.^.^.....
...............
....^.^...^....
...............
...^.^...^.^...
...............
..^...^.....^..
...............
.^.^.^.^.^...^.
...............
~

puzzle
Partie 1: nb = 1630
AOC2025Day7.part1
Partie 2: nb = 47857642990160
AOC2025Day7.part2
......................................................................S......................................................................
.............................................................................................................................................
......................................................................^......................................................................
.............................................................................................................................................
.....................................................................^.^.....................................................................
.............................................................................................................................................
....................................................................^...^....................................................................
.............................................................................................................................................
...................................................................^.^.^.^...................................................................
.............................................................................................................................................
..................................................................^.^.^...^..................................................................
.............................................................................................................................................
.................................................................^.....^.^.^.................................................................
.............................................................................................................................................
................................................................^.^...^.^.^.^................................................................
.............................................................................................................................................
...............................................................^.^.^.^...^.^.^...............................................................
.............................................................................................................................................
..............................................................^.^.^.^.^...^.^.^..............................................................
.............................................................................................................................................
.............................................................^.^.^.....^...^.^.^.............................................................
.............................................................................................................................................
............................................................^.^.^.^.^.^.^.^.^.^.^............................................................
.............................................................................................................................................
...........................................................^.^.^.....^.^.^.....^.^...........................................................
.............................................................................................................................................
..........................................................^.^...^.^...^.^.^.^.^.^.^..........................................................
.............................................................................................................................................
.........................................................^.^.^.^.......^...^.^.^.^.^.........................................................
.............................................................................................................................................
........................................................^.^.^.^.....^.^.^.^.^.^.^...^........................................................
.............................................................................................................................................
.......................................................^.^.........^...^...^.^.....^.^.......................................................
.............................................................................................................................................
......................................................^.^.^.^...^...^...^.^.....^.....^......................................................
.............................................................................................................................................
.....................................................^.^...^...........^.^.^.^.^.^...^.^.....................................................
.............................................................................................................................................
....................................................^.^.^.^...^.....^...^.^...^...^.....^....................................................
.............................................................................................................................................
...................................................^.^.^.^.^.^...^...^.^.^.^.^.^.^.^.^.^.^...................................................
.............................................................................................................................................
..................................................^.^...^.^.^...^.^.^.^.^.^.^.......^...^.^..................................................
.............................................................................................................................................
.................................................^...^.......^...^...^.^...^...^.^...^.^.^.^.................................................
.............................................................................................................................................
................................................^.....^.^.^...^.^.^...^.....^.^.^...^.^...^.^................................................
.............................................................................................................................................
...............................................^.^...^.^.^.^...^...^...^.....^...^...^.^...^.^...............................................
.............................................................................................................................................
..............................................^...........^.^.....^.......^.^.^...^.^.^.^.^.^.^..............................................
.............................................................................................................................................
.............................................^.^.^.^.....^.^.^.^.^...^.......^.^.....^.^...^...^.............................................
.............................................................................................................................................
............................................^...^.^.^...^.^.^.^.....^.^.....^...^...^.^.^.^.^.^.^............................................
.............................................................................................................................................
...........................................^.....^.^.^.^.^.^.^.^.^.^.^.^.^.^...^...^...^.^.^...^.^...........................................
.............................................................................................................................................
..........................................^.^...^.^.^.^...^.^.^.^.^...^...^.^...^...........^...^.^..........................................
.............................................................................................................................................
.........................................^...^.^.^.^.^.^.^.^.^.^.^.^.^.^.^.^.^.^.^.^.^.^.^.^.....^.^.........................................
.............................................................................................................................................
........................................^.^.^.....^.^.^...^.^...^.^...^...^...^.^.^.^.^.....^.^.^.^.^........................................
.............................................................................................................................................
.......................................^.^.^...^...^.^.....^.^.^.^.^.^.^.^.^.^...^.^.^.^.^...^...^...^.......................................
.............................................................................................................................................
......................................^.^.^.^.^.......^.^.^.^.^.^.^.....^...^.^.^.^.^.....^...^.....^.^......................................
.............................................................................................................................................
.....................................^.^.^.^.^.^.^.^.^.^.....^.......^.....^.^.^.^.^...^.^...^.^.^.^.^.^.....................................
.............................................................................................................................................
....................................^.^.^.^.^.^.^.^...^.^.^.^.^.^.^.^.^.^...^.^.^.....^.^.^...^.^.....^.^....................................
.............................................................................................................................................
...................................^.^.^.....^.....^.^.^.^.....^.^.^.^.^.^...^.^...^...^.^.^...^...^.^.^.^...................................
.............................................................................................................................................
..................................^.^.^.^...^.^.....^...^...^.^.^.^.^.....^.^.^.^.^.^...^.^...^.^...^.^.^.^..................................
.............................................................................................................................................
.................................^.^.^.^.^.^...^.^.^...^.^...^.....^.......^.^.^.^.^.^.^.^.^.^.^.....^.....^.................................
.............................................................................................................................................
................................^.^.^.^.^.^.^...^.^...^...^.^.......^...^...^.^...^...^.^...^.^.^.^.^...^.^.^................................
.............................................................................................................................................
...............................^.^...^.^.^.^.^.^.^.^.^.^.......^.^.^.^.^.^.^.....^.^...^.^.....^.^.^...^.^.^.^...............................
.............................................................................................................................................
..............................^.^.^.^...^.^.^.^.^.^.........^...^.^.^.....^...^.^.^.^.^.....^.......^.^.^...^.^..............................
.............................................................................................................................................
.............................^.^...^.^.^.^.....^.^...^.^.^.^...^.^.^...^.^...^.^.^.^.^...^.^.^.....^...^.....^.^.............................
.............................................................................................................................................
............................^.^.^.^.^.^...^...^.^.^.^...^.^...^...^.^...^.^.^.^.^.^...^.^.^.^...^.^.....^.^.^.^.^............................
.............................................................................................................................................
...........................^.^.^.^.^.^.^.^.^...^...^...^.^.^.^...^...^.^.^.^.^.^.^...^.^.^...^.^.......^.^.^.^.^.^...........................
.............................................................................................................................................
..........................^.^.^...^...^...^.^.^.^...^.^.^.^.^.^...^.^.^.^.^...^.....^...^.^.^...^.^.^.....^.^.^.^.^..........................
.............................................................................................................................................
.........................^...^.^...^...^.^.^.^.^.^.^...^.^.^.....^...^...^.^.^.^.^...^.^.^...^.^.^...^.....^.^.^.^.^.........................
.............................................................................................................................................
........................^.^.^...^.^...^...^.^...^.^.^...^.^.^.^.^.^.^...^.^.^.^...^.^...^.^.^.^.^...^.^.^.^.....^.^.^........................
.............................................................................................................................................
.......................^.^.^.^.^.^.^.^.............^.....^.^.....^.^.^...^...^.....^.^.^.^.^...^.......^.^.^.^.......^.......................
.............................................................................................................................................
......................^.^...^.^...^.^.^.^.^.^.^.^.^.^.^.^.^.^.^.^.^.^.....^...^.^.^.^.^.....^.^.^.^.^.^.^.^.^.^.....^.^......................
.............................................................................................................................................
.....................^.^.^.^.^.^...^.......^.^.^.^...^.^.^.^.^.^.....^...^.^.^...^.^.^.^.^...^.^.^.^.^.....^...^.^.^.^.^.....................
.............................................................................................................................................
....................^.^.^...^.^.^.^.^.^.^.^.^.^.^.^.^.^.^.^.^.^.......^.^.^.^.^.^.^.^...^.^...^.^.^.^...^.^.^.^.^...^.^.^....................
.............................................................................................................................................
...................^.......^...^.^.....^.^.^.^...^.^...^...^...^...^.^...^...^.^.^.......^.^.^.^.^...^...^...^.^...^.....^...................
.............................................................................................................................................
..................^.^...^...^.^.^...^...^.^...^.^.^.......^.^...^.^.^.^.^.^.^.^.^.^...^...^.....^.^.^.^...^.^.......^.^.^.^..................
.............................................................................................................................................
.................^.^.^.^.^.^.^...^.....^...^.^.^.^...^.^...^.^.....^.^...^...^...^.^.^.^...^...^.^.^.^.^.....^.^.^...^.^.^.^.................
.............................................................................................................................................
................^.^.^.^...^.^.^.^.......^.^...^...^.^...^.^.^.....^...^.^.^.^.^...^.^.^.^.^.^.^.^...^.^.^.^.^.......^...^...^................
.............................................................................................................................................
...............^.^.^.^.^.^.^...^.^.^.^.......^.^.....^...^.^.^.....^...^.^.^...^.^...^...^...^.^.^.....^...^.^...^...^.^.^...^...............
.............................................................................................................................................
..............^.^.....^.^.^...^...^.^.^.^...^.^.^...^.^...^.........^...^.^...^...^.^.^.....^.^.....^.^...^.^...^.^.^...^.^.^.^..............
.............................................................................................................................................
.............^...^...^.......^.^.^...^.^...^...^.....^...^.^.^.^.^.^.....^.^.......^.^.^.^.^...^.^...^.^.^.^.^.^...^.^.^.^.....^.............
.............................................................................................................................................
............^.^.^...^.^.^.^...^...^.^.^...^.^.^.^.^.^.^...^.^.^.^...^.....^.^.^...^.^.^.^...^.^.....^.^.^.^...^.^.^...^.^...^...^............
.............................................................................................................................................
...........^.^.^...^.^.^.^...^.^.^.^.^.^.^.^.......^.^.^.....^...^.^.^.^.....^.^...^.^.^...^.^...^...^...^.^...^.^.^.^.^.....^.^.^...........
.............................................................................................................................................
..........^.....^.^.^.^.^.^.^.^.^.^.^.^...^.^.^.^.^.^.^...^.^.^.....^.^.^...^.^.^.^...^...^.^.^...^.....^...^.^...^.....^.....^...^..........
.............................................................................................................................................
.........^.^...^.^.^...^.^...^...^.^.^.^...^.^.^.^.^.....^...^.^...^...^...^...^.^.^...^...^.^.^.^.^.....^.^.^.....^...^.^.^.^.^.^.^.........
.............................................................................................................................................
........^.^...^.......^.^.^.....^.^.^.^.^.^.^...^.^.^.....^.^.^.^.^.......^...^.^.^.^...^.....^.^.^.^.^...^.^.....^.^.^.^.^.^.^.^...^........
.............................................................................................................................................
.......^.^.^.....^...^.^.^...^.^.^.^.^.....^.^.....^.^.^.^.^.^.^.^...^.^...^...^.^.^.^.^...^.......^.^...^.....^...^.^.^.^.^.^.^.^.^.^.......
.............................................................................................................................................
......^...^.^...........^.^.^.......^...^.^.^.^.^.^.^.^.^...^.^.^.^.^...^.....^...^.^.^.^.^.^...^.^...^.....^...^.^.^.^...^...^.^...^.^......
.............................................................................................................................................
.....^.^.^...^.....^.....^.^.....^...^.^.^.^.^...^.^.^.^.^.^.......^...^...^.^...^...^.^.^.^...^...^.......^.....^.^.^...^.^.^.^.^...^.^.....
.............................................................................................................................................
....^.^.^.^.^...^.^...^.^.^.^.^...^.^...^...^...^.^.^...^.^.^.......^.^.^.^.^.^.^...^.^.....^.^.^.^.^.^.^.^.^.^.^.^.........^.^...^.^...^....
.............................................................................................................................................
...^.^...^.^.^.^.^.^.^.^.^.^.......^.^...^...^...^.^.^.^...^.^...^...^.^...^.^...^.^.^...^...^...^.....^...^.....^.^.^.^...^.^...^.^...^.^...
.............................................................................................................................................
..^...^...^...^.^.^...^...^.^.^...^.^.^...^.....^.....^...^.^.......^...^...^.^.........^...^...^.^...^...^...^.....^.^.^.^.^.^.........^.^..
.............................................................................................................................................
.^...^.^.^.^.^.^.^.^...^.^...^.^.^...^.^.^...^...^.^...^.^...^...^...^.^.^.^.^.^.^.^.^.^.^...^.^.....^.....^.^.^.^.^.^.^.......^.^.^.^.^...^.
.............................................................................................................................................
~
