MODULE AOC2024Day9;
  IMPORT Texts, TE := TextsEx2, Oberon;

  VAR W: Texts.Writer;
    map: ARRAY 160000 OF INTEGER; id, bl: INTEGER;

  PROCEDURE loadMap;
    VAR S!: TE.Scanner; ch: CHAR;
      j: INTEGER; file: BOOLEAN;
  BEGIN Texts.OpenScanner(S, Oberon.Par.text, Oberon.Par.pos); ch := S.nextCh;
    id := 0; bl := 0; file := TRUE;
    WHILE ((ch >= "0") & (ch <= "9")) OR (ch = Texts.CR) OR (ch = " ") DO
      IF (ch >= "0") & (ch <= "9") THEN
        FOR j := 0 TO ORD(ch) - (ORD("0") + 1) DO
          IF file THEN map[bl] := id ELSE map[bl] := -1 END; INC(bl)
        END;
        IF file THEN INC(id) END;
        file := ~file;
      END;
      Texts.Read(S, ch)
    END;
  END loadMap;

  PROCEDURE part1*;
    VAR i, l, r, t: INTEGER; s: LONGINT;
  BEGIN loadMap;
    (* compactage *)
    l := 0; r := bl - 1;
    WHILE l < r DO
      WHILE (l < r) & (map[l] # -1) DO INC(l) END; (* aller au prochain bloc libre *)
      WHILE (l < r) & (map[r] = -1) DO DEC(r) END; (* aller au dernier bloc utilis\E9 *)
      IF l < r THEN t := map[l]; map[l] := map[r]; map[r] := t END; (* permuter les blocs *)
    END;

    (* calcul checksum *)
    s := 0; FOR i := 0 TO bl - 1 DO IF map[i] # -1 THEN INC(s, 0L + i*map[i]) END END;

    Texts.WriteString(W, "Partie 1: somme = "); TE.WriteLongInt(W, s, 1); Texts.WriteLn(W);
    Texts.Append(Oberon.Log, W.buf)
  END part1;

  PROCEDURE part2*;
    VAR i, j, l, r, t, sz, fsz: INTEGER; s: LONGINT;
  BEGIN loadMap;
    (* compactage *)
    r := bl - 1;
    FOR i := id - 1 TO 1 BY -1 DO LED(i);
      WHILE (r >= 0) & (map[r] # i)DO DEC(r) END; (** aller au dernier bloc du fichier i *)
      sz := 0; REPEAT INC(sz); DEC(r) UNTIL (r < 0) OR (map[r] # i); INC(r);
      (* recherche d'une zone libre de taille suffisante *)
      l := 0;
      WHILE l < r DO
        WHILE (l < r) & (map[l] # -1) DO INC(l) END; (** aller au prochain bloc libre *)
        fsz := 0;WHILE (l < r) & (map[l] = -1) DO INC(fsz); INC(l) END;
        IF fsz >= sz THEN (* D\E9placer le fichier *)
          FOR j := 0 TO sz - 1 DO map[l - fsz + j] := i; map[r + j] := -1 END;
          l := r (*break*)
        END
      END
    END;

    (* calcul checksum *)
    s := 0; FOR i := 0 TO bl - 1 DO IF map[i] # -1 THEN INC(s, 0L + i*map[i]) END END;

    Texts.WriteString(W, "Partie 2: somme = "); TE.WriteLongInt(W, s, 1); Texts.WriteLn(W);
    Texts.Append(Oberon.Log, W.buf)
  END part2;

BEGIN Texts.OpenWriter(W)
END AOC2024Day9.

System.Free OM4P2 OM4G2 ~
OM4P2.Compile AOC2024Day9.Mod/s ~ System.Free AOC2024Day9 ~

Partie 1: somme = 1928
AOC2024Day9.part1
Partie 2: somme = 2858
AOC2024Day9.part2
2333133121414131402 ~

Partie 1: somme = 6398608069280
AOC2024Day9.part1
Partie 2: somme = 6427437134372
AOC2024Day9.part2
988335673375206965666118194977976066833694787967233463149849201227924856481567874391825744879931939426809716428231343171
217023242771134127844891612355539896325864919225495442865312404862749036365444509846374670526457743433187273901322325785
268632539669716678563882612975524523519070939959873865934450806063516118566332486857388518243346914226501978458573764729
595466747063235655231032498697858244237394668332432496497571441144203230436857121097804045237555443772324162698059404675
311665656350903358221749997499105013461229867629143729883023267045895821911417195445102735236773962047881149562875638654
145471373736635611139622653164779677815644721355726410312584119171384375787930182550553345341247692889177779135173736127
182461925557797558653447638375374491906050189653811450157796599870614177297120953016202961121239433050636655476055598514
248661505986366568703821417969949730151867123522503949225215283171667624927645971587387838407346407210713011501739786133
983997461226224066589896158677187853173460783371654338895714882918667851292817703394609062933352973350618818649161389779
574619567680948364733265645218426845316365702014205037276549633668324781188493569220111780159226983424454230922275184060
415559882222779830939449836376488378686212185773654078826147422772757341217592107591161337826958372349356416919370304810
758782487450706217266231619946434892407956898020704319774773169964402675773554272681318128664422821867204642799084722183
237778916539715339437531748876388933378712321940781921516852957990873188622623926850297570648744141699735668206430599863
632830711366435556484086836197847257384116483685263826238025455899827633131125932193644935131483969192694322176845323564
927070118157662689405938997449933964671073271669394472667059701421631745553615485091257021172342108472683716306667845149
429883585639517716979944698462194280612635371950347682466439799414197125245584239973718485768030955596858326739515191846
777914208188501632964035873431865161481527471421736181954141124548274494272722372434103671976229509369159394364269598190
424581176393143750666416901925338647796220561597814665612280923916415398404169592078838615252615665156716152961346107594
998711243468843057793130956616993865823813138874867350239319296673272766917689223091933551204276801975249042992461499554
879048523691989257258116591818188994598162599167938813974039288618507070406939145872939662906496771929415798542851274948
506870315162944451582664146536379431166890745854707428741922744815429719201160366430929241617813168364475287205025803722
366789557188173526773161968230369311396661689234789758671654653264751525496920395868203222408661353485609531217339217682
162748735843815592669038899417585583924825959258315811592417658119422813514432121214461240481417381816597119708032401042
557789146353349022855583185432995917736816697366542848914319349836996639703997402245911521282730276978633538371175328987
885888834747776360311695974837191135887294104716913394323087398385119069608475353398756344704422599857854883607489348713
555072857022178764798045127745627189187162463888405296546822791672708786986179555588688596815947479339279552871697247430
628569994017743869426555732177669061422650134951814588703641486242427173517315166621539650995869796346616365179939741522
916811112191255148957039488571534418911011236128243360412416363217535752633711845213215996318234163053968097702175388057
923945708955163499402653828966352832533923632815256695208683603890532422717213283412432959459119192362995074345314599230
606467222276223580796359381769566051517248248945368891957059559143375127303018368371499547875566759332593620458494132696
919722647112868272899984597828819049274451843178341633947874329018216359365860415779259527434741438686604855343019892382
833687369329585183146528704711248672534963208190533375833111999621112756623450229541828255816131253778173858411239161485
651629587295589853888170249450227592243813195480327595797330514958696710622097467272401836119218611890612816317662667487
324487451843143696684021817872429614205464233255741812913241495612321440715841967959627918134174549581303923514319403744
176911521767618110722437868628804465962381598840509357714127449149427028454618458374787321405342332445884631446228286239
247231808433606053173815182948507629578211304050136547736452416650566031686595232660966179814359265134105422879935881775
907768755931845128782918458438509376384892472011443761542790485216652258645354918917851369166996306220237776771386608496
913858122164464238839951557253271743815926343258329355975454966929657875898434708662754646572960542590534210199541657333
559215891846688254164324919990169746735347225017585247993879141429516543314479669147848647125130152643929674445753647935
141325475191326229281040185117704028695992925268597946217392845342418174237515307262137019698761898093908167847762124851
239716149656137479788637188513469139818520441386334884613358952013417668144578739978609581893366438418342758272846141637
281136489687518681419239753718224420929769937478232954837098228324456834718037743869743676958821114748957222586928991567
873540597795561178672296283942587589614583615753214817759032367366159567576039887967495858868494175752766013128449509058
712042939591675359562171848792528832427651189738725989461454301715526975798016587738681628959858112974155382692127981584
999760129547731821767163388645958319979266465279223755355729887991119172666495752262828048855960933167316147121549126165
607783302515624322361365126781293664791592277160229187824942645665717087776665244011972579813723669744624362374795209219
829849129371755134406089915993435675471328723398877559791340783383282151771020797289615463777394975254965231635078406143
376317588735429497344343207549106329563571867986527171719769275121689846646497772737303573533761964231589722828677804693
597267629115709479263748636734469792616436267211884012623422202216781047482840425970163533983861968862116547777351981397
597411905065796247195196766213582636192767436591293254421032788339476474269349249835863979791379316567522026326776451518
789659416698839832314498884433231040927644839788841131418588201953835943441089899197502360903211176719698374685219172711
769431252552931297942256398359666723124473569622776823182339425470636786142799991584157487173950295849502492148237526434
772511741836925043746379332978522490599268449497699434541366325262919052616949243786302781182739507263849331983441167997
359883392691763531823084754992648698455557593626516124908367995777587845643024488578118952781058676737157026873333961491
632549249872286146214514458517208378562755845156964724237264711360257096309519552625174774337748463720842916939184179157
657782154878474384704560384825357339672698601048848572451129631777914895327912457273496152514466378854103182943932848576
423638952472575057492495522451215922681074186316766928975130364885124879955410476560153617982187241991643350693655519353
666170663468803929591546183696876916399434111863964091979540414793348458399925526283513050961011529391909480233453163649
184048744195664826975390609154876633328488676956741957649954748495703910305214148166712559667119461726417610297039217920
133756477091221094301520335754942789482251688075712585501748169014319385976969892375931535386020547776405244611015887320
816714615977303160954559861392492240395789431991448621427628537326793132651792579671344011953095968146542250243112478740
721071901660128947301193696063443586547272841259403831437737162998932545126059704098707941924421662521904292804943646282
376739654562766238446820863691135693541286648868222310509870435191768646231746273749507825953381972456319614274038387083
897039882489721862456315391824344428893298629958387943477787272879739195109651736115703197522048782496476520683341759158
432041307095756546275086946811806873988735335617325188387956499178233498323999467567118796464834874636497793294157809810
649751827459362999873945286723372430161724774746118167503356975740591462408461743130468855166380245560169995244871853722
702864239464784587503016287347415578757038923250211183305378675839719744491228571593164145286645901613557143842090559618
231885174351397327488564398876753969991342228246598469303123344564154743229232449781688158488192145540754698354398274491
422321148155171338859016544346714383621370411693664491323430273241947671453665349254165019353858376667598041122525838890
446980833354877638937355479816205795399418774979215772119141711587941892365256692432217511337012329124886613193472803087
112927375632313845452674439771447716466267817026676720773814173732244445726281888991865772304727733663931142266129224541
566466567993972068508998627597275546987661926580757286969181254014311694618830577252545198431652914294384773976936408966
827853234147266889996454867180167754765528452469152284586390766133242547304879629152906010464694354324264478599366748460
432261992671413536366424223479781866982528434964106734883463882593797653116470299365475526702646802828232215131832338354
491289179958492741939971125793282052401951164898314770731941621213876198317961407594788451375158748055634326713851122049
273093219490309512999786566775202589617816877831276967697331374194636415828466367671258112619159474945669635694398298571
979271812028307163489463978287638494261918662928551424464644627681155958593878499651353921708049759026404059546889947182
631352804522231197365913622416847447707326371071431240151629875278372373313257629437514891754980168724772578609695391063
561215842326402636476740162967297714282467588443797881887753265046781388133588718416989780194947913956112155737471426811
231219967469337838312355184112415252563583148376908420128522298852922552642772482051261197671775703261633047526968429880
233272151817238264326156879811575976367421853993306528876988202927652698893299743966882925257317769831129414998377505012
949497133215583422954261438461436378929958246861948179475353887823707882209317748022961689365073961818656047785349401580
819099938618722111283568266177853025435352814592964674707041858899287486983433674778416080363911986990843470828681673791
941693676648436578996168958120266717841284141823792197433593183416238192449553257130328613504778169053142540308566252073
497432572096191970665397343843227744413225763572323624248157173615761472161993791294623570837067728468428728686291774288
105598832731145730154677824485112872456853353759413853717863929735388070563761288587713633601321411828397567979213453632
666222854888248767166550818976643374746379553345263925946539135818169758706527913818431460295937185462167583843583225833
649623761777999373566741823417614693643625916894739668299989495565905581712735756759339479737516281649511274221147242141
754273446160432887726834713267752883336510139954917710598664544911999656133857698373276136781318527533586129259426744151
654697888586873153719564945889652454612469326816224830649369783938336345452195891575193092521321762771347252183036338888
281398133329337847963365193198459592318392992270283496684428545646944510512689685436869694625466838164178830598646224083
539322978399908015643071693018145719593565639778495254283028978590925215398253333245802280347418451623476368452170562281
114567908215128735672353799935681451253252894952896957914915342026152571733672825485545782798024242730425731643782186816
172637529774542671104876906087924568115983843859556423108289159718514747432918529124519310495434126682701246611942771071
636176249649727152673064324162779077866795989634506460843866289376113051282984712114544321463941228127764624426429347986
973677685244619866937460137163655471172684589235765437859020827266512916608623663671815752433781165227928384562010395148
466220444413703783859371657493203181542723105663558060854629623338659857196838444144326364854751365749775860376573835452
815757831826646056564412567669484891362290531782598054222679169512378372888159209892224374193460724189238076445927274169
581774736286803857716535982928704799491666195858344754371626574349108434988230969627913141677119246389487179827625603832
998692765821624484124392914551899227472193589271703775198741102212999867449898194290622282979588166783105085725417992963
669786215555708120724833601284936858684636424668246859658422791865932934719481277658936183149158581442102335767610217587
636383259527411413753620957454482536221956131928493821402490374880353939267952846629982489655080444344661318828135344446
888562531063829395201034696499552486103452919798496447837669443177847537432564277060925146705721927436793283386982278351
471883656350616353433854848411457635945980235488631174196062827947984117879589384555156826939957784617227912416143548934
266858634931732987267432622886396281364531542341701567611267557190561166334914515353103440301012123041352523724392656844
333849535656803799987036821263142497101563925219767689621858222127163363958486388347642280109398291585598931507998148111
565365651539659714451699288470778825445689802110575215935020768979762520377424882866682417804923821154507271775614102045
308693959635806715445446982748574916521822344594873916333376924167932582604957248873997858156032186546255868641223286876
621138757944389898747293306336227327662164857087941654218072731436915437794065896565153713676940191042498443447459971762
812327733063259771705232851496128098769218477452911116599637671333571691509750377819674195974397671257809666384391952784
374896626364526848657248733319986664741430251718599094427518927959947610894881484447979745199485749882513930899936227797
583875237387684976535340632151849371902460139896711712667568443832421470725596355191262781272682346727144010456995963870
125467384768689232265926943819129245464058991517105454177986496019687275999327299999436155893032222633925055292887805161
207010491371959276973952754366436320829984505159821815931516529270633139613357669233114886966578318747316377947512771114
499884147395418471129695967099803523576374752964745618825261639751106449583262261051262242982144501632782097575599869384
236213446560927086303312996156239654943533858619856399221684614298993224996910153543568488902221851086631882436752657294
479570126653125996629182633156595018982564717468283818377442794741556081681161205035273726397310528181238992142271108716
418256867031716564671418244066105538147824718180858051174647687472144576297644414197758817332824213122714748804310235180
669867228066312817435233651493859930513188969314233612906681361143442470246724736259301338655935382197158967909781157549
739919691114399249627465597871588313658560693043766816622556658674117866383033774866612065431334556413188835194275192981
335261656858353165646016136026228798905592344911572331431263859864434735785210122963821129523582619941952956407225577698
827826604160651036448442127247426967133323317175591664744461705779277736275845649382311469101991682379456369322456796569
977240473849889289255798734975304550718986275651347996308491843384604329777371355218473517844452852950792284785018274867
183510589296405838482412994841569090906746925280211228994074702010704261891397569411386184129631544899833872977070607517
644764467237264295596340702786653161134295996828135667269692429366823537869752566491272478402716485820109452757928762467
918119723436148268407787127672878815943569935056424670117726785368542136647941897738486780295580306762301842104359674129
539511738145452318642261543039819624282521813975649810777629991992399027761431751425431964717616477453905946945927315618
468713488673228934725932308246195997315536457655304115795244362942239479612059488838549654517777587575632586192621429118
506348129487492873142279959828548245984935819563614857911641712174547644927982324286606610282327434399463123302991399747
263696384716505365369610532518153138175076913364595635436572298221973465134018817467332794433189342749681049158942727028
963940264622671128701019727734517331825150775514664354763052828995453050311234278087551931276013814161932249632465726442
863030355226936953414855714429874322478645928532247267368194312555498594816384257512968223666112765534605458939381765838
659641926832865625746742981545387940957851859270681588657386387937861170278246823040802997802819385813749878155079889733
739061583945719939742811141372277776367612836460633490937443967667367285353172641761698786718791472273985089862729919654
126214567015201621919085749921116845379769297757295928159792939782296247771761598439627416493950602277675494134118216074
896996876759861716958166239777142861689918691569649533867945103599975783437035492487911374154994279577292366855894737791
578731439637139478457496865615865756503469332745666917754291505190557547605978322054593823451166439688236013928617504629
821743676076647844414423901574186984602959219848663095199355702961437947645185562670442012848232745130621179144551434348
543883483825481752856746189542443492773759695331598730104186424618807662409988222513898597407031509689524737159431551894
129973536819566397625587631153611787767169671389657123968940741110586375655712678531679530832193504168824320479364678243
284289661532824041117815238083631079842144141499855066272113336770769562471089607935699699339886342673193136713627885514
425995837412358821909830131343405217608710426081454547598471523261413528106448552063564798572391754969854763516171415694
649160489513258317591593698632174778478215932783221626236351231446304783202581365086658046142623978691941089263835498624
831218607860761329236144494148122563193820717935218310149174358320252571893675517627374547651479741967938541365258378969
554445257448891093141980309438297233166215593423751966303582446213905696929359622338674027139624464881262620868579515178
319880876553371676221590328631482467978970696691973098138912986822326450914991832623135494977559289477306094772123177156
752079509343594329893553112715603615322952789315819369254739415798534489277857639616585394143327256385462923241541455810
946816858052401785288792486785919382411387479983617579564235218950609374777162228679591332178183521424703949416714302492
611078596399524316812012415117511752758551478842302334354833705348955845425228311944781765721498589166294578926381277297
759941567776119638163043621754265918977489547390506831281011479540411575297180789237294438503954276559932017206239391967
569386317820428573819631166443213143719889589516707964243874497179467362347238432132713029524490528736334923156973474875
263444343386299171862412329349379575348235295887688818672982783413691049752111322938237826472446503749881779594430197155
492663988434491786435291285081518237351938237019341637777078901382744571129063707746323549454983425351885820806320883732
402896865039809329341523825020958447667081327057733323644744947691584165772540364051344098984844409626114660409317786585
686761286755434864272738649583178689685447314383937579228936869595167765133079588172235491916598574436464549558838763576
551258533699494094705040356491257364416212926115886322669795918018585322528594893347369442934162284510891098605795818622
828338859660938938295784898067152495989233337989991078514969673268611732951364425264498169176931395156203742122299332751
147594632033751833243435651171225991916068416812973162551970971910851558384622635799183266296365442713335951723977198714
969294956023595287384547936571664925548533645864167865255783241895836427377345455892184067929128209740146179462979276989
882122469417178931837118563458166457579021191430368080634695335557703513696537353034908321661490771395596567416339666680
259199376776738754895968118351769270205175169027994837154668978627571795369283963086925393964373964463208173783963639296
914081987036461189335481117127734189777294268530754137897872552527554428626365837064273021214299167797988858631815578799
829819729078662772472987112712922664907736952221491559191561328442223496823793271868549653914029769279772865617357702754
157331863190588991392027816896529250399749613884726540459224622172119761205887502181824053136865688532473377615985547023
525043966749533150525196438196279064471321641495406745172423217799131128543725557585395192402276975656855775988893478428
943176681016579877512475234876976481265348503465238888594526676195904789575640746841836381501883767037856459527185618417
6694895293417846989544812915358344271478803880344167564821918594453538344091329


OM4Tool.DecObj AOC2024Day7.m4c
