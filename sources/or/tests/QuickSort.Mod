MODULE QuickSort;
  TYPE
    Item* = POINTER TO ItemPayload;
    ItemPayload* = RECORD
    END;
    
    LT* = PROCEDURE(a, b: Item): BOOLEAN;
    
  PROCEDURE doSort(VAR a: ARRAY OF Item; L, R: INTEGER; cmp: LT);
    VAR i, j: INTEGER; w, x: Item;
  BEGIN
    i := L; j := R;
    x := a[(L+R) DIV 2];
    REPEAT
      WHILE cmp(a[i], x) DO i := i+1 END;
      WHILE cmp(x, a[j]) DO j := j-1 END;
      IF i <= j THEN
        w := a[i]; a[i] := a[j]; a[j] := w;
        i := i+1; j := j-1
      END
    UNTIL i > j;
    IF L < j THEN doSort(a, L, j, cmp) END;
    IF i < R THEN doSort(a, i, R, cmp) END
  END doSort;

  PROCEDURE Sort*(VAR a: ARRAY OF Item; cmp: LT);
  BEGIN
    doSort(a, 0, LEN(a)-1, cmp)
  END Sort;

END QuickSort.

(*

OM4Tool.DecObj QuickSort.m4c ~

decode QuickSort.m4c
QuickSort 6C618B42   1   392
imports:
type descriptors
 00000020 FFFFFFFF FFFFFFFF FFFFFFFF FFFFFFFF
data     0
strings

code
commands:
entries
   342     0   312
pointer refs

fixP =        0
fixD =        0
fixT =        0
entry =      342
 00000000	 F1BD0D10	SUBS SP SP #16
 00000004	     B41F	PUSH R0 R1 R2 R3 R4
 00000006	     B500	PUSH LR
 00000008	     9803	LDR R0 [SP + 12]
 0000000A	     9006	STR R0 [SP + 24]
 0000000C	     9804	LDR R0 [SP + 16]
 0000000E	     9007	STR R0 [SP + 28]
 00000010	     9803	LDR R0 [SP + 12]
 00000012	     9904	LDR R1 [SP + 16]
 00000014	     1840	ADDS R0 R0 R1
 00000016	     1040	ASRS R0 R0 #1
 00000018	     9902	LDR R1 [SP + 8]
 0000001A	     4288	CMP R0 R1
 0000001C	     BF28	IT CS
 0000001E	 EC002381	TrapCS 1 at pos 312
 00000022	     9901	LDR R1 [SP + 4]
 00000024	 EB110080	ADDS R0 R1 R0 LSL #2
 00000028	     6800	LDR R0 [ R0 + 0]
 0000002A	     9009	STR R0 [SP + 36]
 0000002C	     9806	LDR R0 [SP + 24]
 0000002E	     9902	LDR R1 [SP + 8]
 00000030	     4288	CMP R0 R1
 00000032	     BF28	IT CS
 00000034	 EC0025B1	TrapCS 1 at pos 347
 00000038	     9901	LDR R1 [SP + 4]
 0000003A	 EB110080	ADDS R0 R1 R0 LSL #2
 0000003E	     6800	LDR R0 [ R0 + 0]
 00000040	     9909	LDR R1 [SP + 36]
 00000042	     9A05	LDR R2 [SP + 20]
 00000044	     2A00	CMP R2 #0
 00000046	     BF08	IT EQ
 00000048	 EC002625	TrapEQ 5 at pos 354
 0000004C	     4790	BLX R2
 0000004E	     2800	CMP R0 #0
 00000050	 F0008004	BEQ #8, goes to  0000005C
 00000054	     9806	LDR R0 [SP + 24]
 00000056	     1C40	ADDS R0 R0 #1
 00000058	     9006	STR R0 [SP + 24]
 0000005A	     E7E7	B #-50, goes to  0000002C
 0000005C	     9809	LDR R0 [SP + 36]
 0000005E	     9907	LDR R1 [SP + 28]
 00000060	     9A02	LDR R2 [SP + 8]
 00000062	     4291	CMP R1 R2
 00000064	     BF28	IT CS
 00000066	 EC003091	TrapCS 1 at pos 393
 0000006A	     9A01	LDR R2 [SP + 4]
 0000006C	 EB120181	ADDS R1 R2 R1 LSL #2
 00000070	     6809	LDR R1 [ R1 + 0]
 00000072	     9A05	LDR R2 [SP + 20]
 00000074	     2A00	CMP R2 #0
 00000076	     BF08	IT EQ
 00000078	 EC0030D5	TrapEQ 5 at pos 397
 0000007C	     4790	BLX R2
 0000007E	     2800	CMP R0 #0
 00000080	 F0008004	BEQ #8, goes to  0000008C
 00000084	     9807	LDR R0 [SP + 28]
 00000086	     1E40	SUBS R0 R0 #1
 00000088	     9007	STR R0 [SP + 28]
 0000008A	     E7E7	B #-50, goes to  0000005C
 0000008C	     9806	LDR R0 [SP + 24]
 0000008E	     9907	LDR R1 [SP + 28]
 00000090	     4288	CMP R0 R1
 00000092	 F3008030	BGT #96, goes to  000000F6
 00000096	     9806	LDR R0 [SP + 24]
 00000098	     9902	LDR R1 [SP + 8]
 0000009A	     4288	CMP R0 R1
 0000009C	     BF28	IT CS
 0000009E	 EC003441	TrapCS 1 at pos 452
 000000A2	     9901	LDR R1 [SP + 4]
 000000A4	 EB110080	ADDS R0 R1 R0 LSL #2
 000000A8	     6800	LDR R0 [ R0 + 0]
 000000AA	     9008	STR R0 [SP + 32]
 000000AC	     9806	LDR R0 [SP + 24]
 000000AE	     9902	LDR R1 [SP + 8]
 000000B0	     4288	CMP R0 R1
 000000B2	     BF28	IT CS
 000000B4	 EC0034A1	TrapCS 1 at pos 458
 000000B8	     9901	LDR R1 [SP + 4]
 000000BA	 EB110080	ADDS R0 R1 R0 LSL #2
 000000BE	     9907	LDR R1 [SP + 28]
 000000C0	     9A02	LDR R2 [SP + 8]
 000000C2	     4291	CMP R1 R2
 000000C4	     BF28	IT CS
 000000C6	 EC003521	TrapCS 1 at pos 466
 000000CA	     9A01	LDR R2 [SP + 4]
 000000CC	 EB120181	ADDS R1 R2 R1 LSL #2
 000000D0	     6809	LDR R1 [ R1 + 0]
 000000D2	     6001	STR R1 [ R0 + 0]
 000000D4	     9807	LDR R0 [SP + 28]
 000000D6	     9902	LDR R1 [SP + 8]
 000000D8	     4288	CMP R0 R1
 000000DA	     BF28	IT CS
 000000DC	 EC003581	TrapCS 1 at pos 472
 000000E0	     9901	LDR R1 [SP + 4]
 000000E2	 EB110080	ADDS R0 R1 R0 LSL #2
 000000E6	     9908	LDR R1 [SP + 32]
 000000E8	     6001	STR R1 [ R0 + 0]
 000000EA	     9806	LDR R0 [SP + 24]
 000000EC	     1C40	ADDS R0 R0 #1
 000000EE	     9006	STR R0 [SP + 24]
 000000F0	     9807	LDR R0 [SP + 28]
 000000F2	     1E40	SUBS R0 R0 #1
 000000F4	     9007	STR R0 [SP + 28]
 000000F6	     9806	LDR R0 [SP + 24]
 000000F8	     9907	LDR R1 [SP + 28]
 000000FA	     4288	CMP R0 R1
 000000FC	     DD96	BLE #-212, goes to  0000002C
 000000FE	     9803	LDR R0 [SP + 12]
 00000100	     9907	LDR R1 [SP + 28]
 00000102	     4288	CMP R0 R1
 00000104	 F2808007	BGE #14, goes to  00000116
 00000108	     9801	LDR R0 [SP + 4]
 0000010A	     9902	LDR R1 [SP + 8]
 0000010C	     9A03	LDR R2 [SP + 12]
 0000010E	     9B07	LDR R3 [SP + 28]
 00000110	     9C05	LDR R4 [SP + 20]
 00000112	 F7FFFF75	BL #-278, goes to  00000000
 00000116	     9806	LDR R0 [SP + 24]
 00000118	     9904	LDR R1 [SP + 16]
 0000011A	     4288	CMP R0 R1
 0000011C	 F2808007	BGE #14, goes to  0000012E
 00000120	     9801	LDR R0 [SP + 4]
 00000122	     9902	LDR R1 [SP + 8]
 00000124	     9A06	LDR R2 [SP + 24]
 00000126	     9B04	LDR R3 [SP + 16]
 00000128	     9C05	LDR R4 [SP + 20]
 0000012A	 F7FFFF69	BL #-302, goes to  00000000
 0000012E	 F85DEB04	LDR LR [ SP ] + 4
 00000132	 F11D0D24	ADDS SP SP #36
 00000136	     4770	BX LR
 00000138	     B407	PUSH R0 R1 R2
 0000013A	     B500	PUSH LR
 0000013C	     9801	LDR R0 [SP + 4]
 0000013E	     9902	LDR R1 [SP + 8]
 00000140	     2200	MOVS R2 #0
 00000142	     9B02	LDR R3 [SP + 8]
 00000144	     1E5B	SUBS R3 R3 #1
 00000146	     9C03	LDR R4 [SP + 12]
 00000148	 F7FFFF5A	BL #-332, goes to  00000000
 0000014C	 F85DEB04	LDR LR [ SP ] + 4
 00000150	 F11D0D0C	ADDS SP SP #12
 00000154	     4770	BX LR
 00000156	     B500	PUSH LR
 00000158	 F85DEB04	LDR LR [ SP ] + 4
 0000015C	     4770	BX LR

*)
